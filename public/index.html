<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>INAS OPME</title>
    <style>
        :root {
            --maida-branco: #ffffff;
            --maida-amarelo: #ffcc00;
            --maida-rosa: #ff0073;
            --maida-azul: #0070ff;
            --maida-cinza-escuro: #585958;
            --cinza-claro-fundo: #f8f9fa;
            --maida-cinza-claro: #dddddd;
            --vermelho-negado: #dc3545;
            --verde-autorizado: #28a745;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--cinza-claro-fundo); color: var(--maida-cinza-escuro); line-height: 1.6; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; padding: 0; }
        .header { background: var(--maida-azul); color: var(--maida-branco); padding: 1.5rem 2rem; border-radius: 15px; margin-bottom: 2rem; box-shadow: 0 4px 15px rgba(0, 112, 255, 0.2); text-align: center; }
        .header h1 { font-size: 1.5rem; font-weight: 700; margin: 0; }
        .controls { background: var(--maida-branco); padding: 1.5rem; border-radius: 12px; margin-bottom: 2rem; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); text-align: center; }
        .btn-buscar { background: var(--maida-azul); color: var(--maida-branco); border: none; padding: 12px 30px; font-size: 1.1rem; border-radius: 25px; cursor: pointer; transition: all 0.3s ease; font-weight: 600; box-shadow: 0 4px 15px rgba(0, 112, 255, 0.3); }
        .btn-buscar:hover:not(:disabled) { background: var(--maida-rosa); box-shadow: 0 6px 20px rgba(255, 0, 115, 0.4); }
        .btn-buscar:disabled { background: var(--maida-cinza-claro); color: var(--maida-cinza-escuro); cursor: not-allowed; transform: none; box-shadow: none; }
        
        .loading { display: none; text-align: center; margin: 2rem 0; padding: 1.5rem; background: #fff; border-radius: 12px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); }
        .spinner { border: 4px solid var(--maida-cinza-claro); border-top: 4px solid var(--maida-azul); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 1rem; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .progress-container { background: var(--maida-cinza-claro); border-radius: 10px; height: 20px; margin: 1rem auto; max-width: 400px; overflow: hidden; position: relative; }
        .progress-bar { background: var(--maida-azul); height: 100%; width: 0%; transition: width 0.3s ease; border-radius: 10px; }
        .progress-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: var(--maida-branco); font-weight: 600; font-size: 0.9rem; }
        .progress-details { margin-top: 0.5rem; font-size: 0.9rem; color: var(--maida-cinza-escuro); }

        .resumo { background: var(--maida-branco); padding: 1.5rem; border-radius: 12px; margin-bottom: 2rem; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); }
        .resumo h2 { margin-bottom: 1rem; color: var(--maida-azul); }
        .resumo-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }
        .resumo-item { text-align: center; padding: 1rem; border-radius: 8px; background: var(--cinza-claro-fundo); border: 1px solid var(--maida-cinza-claro); }
        .resumo-item.autorizadas { border-left: 4px solid var(--verde-autorizado); background: #f8fff9; }
        .resumo-item.parciais { border-left: 4px solid var(--maida-amarelo); background: #fffef5; }
        .resumo-item.negadas { border-left: 4px solid var(--vermelho-negado); background: #fff5f5; }
        .resumo-item.analise { border-left: 4px solid var(--maida-azul); background: #f5f9ff; }
        .resumo-item.semGuiaOrigem { border-left: 4px solid #6c757d; background: #f8f9fa; }
        .resumo-numero { font-size: 2rem; font-weight: bold; margin-bottom: 0.5rem; color: var(--maida-azul); }
        .resumo-item.autorizadas .resumo-numero { color: var(--verde-autorizado); }
        .resumo-item.parciais .resumo-numero { color: #856404; }
        .resumo-item.negadas .resumo-numero { color: var(--vermelho-negado); }
        .resumo-porcentagem { font-size: 0.8rem; color: var(--maida-cinza-escuro); opacity: 0.8; }

        .guias-container { display: grid; gap: 1rem; }
        .categoria { margin-bottom: 2rem; }
        .categoria-titulo { background: var(--maida-branco); padding: 1rem 1.5rem; border-radius: 10px; margin-bottom: 1rem; font-size: 1.3rem; font-weight: 600; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); display: flex; justify-content: space-between; align-items: center; border: 1px solid var(--maida-cinza-claro); }
        .categoria-stats { font-size: 1rem; color: var(--maida-cinza-escuro); opacity: 0.8; }
        
        .guia-card { background: var(--maida-branco); border-radius: 10px; padding: 1.5rem; margin-bottom: 1rem; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); transition: all 0.3s ease; border-left: 4px solid var(--maida-azul); border: 1px solid var(--maida-cinza-claro); }
        .categoria-autorizadas .guia-card { border-left-color: var(--verde-autorizado); }
        .categoria-parcialmenteAutorizadas .guia-card { border-left-color: var(--maida-amarelo); }
        .categoria-negadas .guia-card { border-left-color: var(--vermelho-negado); }
        .categoria-semGuiaOrigem .guia-card { border-left-color: #6c757d; }
        
        .guia-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .guia-info h3 { color: var(--maida-azul); margin-bottom: 0.5rem; font-size: 1.1rem; }
        .guia-detalhes { color: var(--maida-cinza-escuro); font-size: 0.95rem; }
        
        .guia-status { padding: 4px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 600; border: 1px solid rgba(0, 0, 0, 0.1); }
        .status-autorizada { background: #d4edda; color: #155724; border-color: #c3e6cb; }
        .status-parcial { background: #fff3cd; color: #856404; border-color: #ffeaa7; }
        .status-negada { background: #f8d7da; color: #721c24; border-color: #f5c6cb; }
        .status-analise { background: #cce7ff; color: var(--maida-azul); border-color: #b3d9ff; }
        .status-nao-encontrada { background: #e9ecef; color: #6c757d; border-color: #d8dadf; }

        .expand-btn { background: none; border: none; font-size: 1rem; color: var(--maida-azul); cursor: pointer; transition: transform 0.3s ease; padding: 5px; border-radius: 50%; }
        .expand-btn.expanded { transform: rotate(180deg); color: var(--maida-rosa); }
        .itens-container { margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--maida-cinza-claro); display: none; }
        .itens-container.show { display: block; }

        .item-lista { background: var(--cinza-claro-fundo); padding: 0.8rem; margin-bottom: 0.5rem; border-radius: 6px; border-left: 3px solid var(--maida-rosa); border: 1px solid var(--maida-cinza-claro); }
        .item-codigo { font-weight: bold; color: var(--maida-azul); font-size: 0.9rem; }
        .item-descricao { color: var(--maida-cinza-escuro); margin: 0.3rem 0; font-size: 0.95rem; }
        .item-quantidades { margin-top: 0.5rem; font-size: 0.85rem; font-weight: 500; }
        .quant-solicitada { color: var(--maida-cinza-escuro); font-weight: bold; }
        .quant-autorizada { color: var(--verde-autorizado); font-weight: bold; }
        .quant-nao-autorizada { color: var(--vermelho-negado); font-weight: bold; }

        .empty-state { text-align: center; padding: 3rem; color: var(--maida-cinza-escuro); background: var(--maida-branco); border-radius: 12px; border: 1px solid var(--maida-cinza-claro); }
        
        @media (max-width: 768px) {
            .guia-header { flex-direction: column; align-items: flex-start; gap: 1rem; }
            .guia-status { align-self: flex-end; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>OPME (INAS)</h1>
        </div>

        <div class="controls">
            <button class="btn-buscar" id="btnBuscar">
                Buscar Guias de Origem
            </button>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <div class="progress-container">
                <div class="progress-bar" id="progressBar"></div>
                <div class="progress-text" id="progressText">0%</div>
            </div>
            <div class="progress-details" id="progressDetails">
                Iniciando busca...
            </div>
        </div>

        <div class="resumo" id="resumo" style="display: none;">
            <h2>Resumo das Guias de Origem</h2>
            <div class="resumo-grid" id="resumoGrid">
                </div>
        </div>

        <div class="guias-container" id="guiasContainer">
                </div>
    </div>

    <script>
        // O frontend se comunica com o backend rodando em http://localhost:3000
        const API_SERVER_URL = 'http://localhost:3000/api/guias-opme-progress';

        document.getElementById('btnBuscar').addEventListener('click', iniciarBusca);

        // --- FUNÇÕES DE LÓGICA DE INTERFACE ---
        
        async function iniciarBusca() {
            const btnBuscar = document.getElementById('btnBuscar');
            const loading = document.getElementById('loading');
            const resumo = document.getElementById('resumo');
            const guiasContainer = document.getElementById('guiasContainer');

            // 1. Resetar e mostrar loading
            btnBuscar.disabled = true;
            loading.style.display = 'block';
            resumo.style.display = 'none';
            guiasContainer.innerHTML = '';
            atualizarProgresso(0, 'Conectando ao servidor backend...');

            // 2. Conectar ao endpoint SSE do backend
            const eventSource = new EventSource(API_SERVER_URL);

            eventSource.onmessage = function(event) {
                const data = JSON.parse(event.data);
                
                if (data.type === 'progress') {
                    atualizarProgresso(data.percent, data.message);
                } else if (data.type === 'complete') {
                    eventSource.close();
                    exibirResultados(data.resultados);
                    atualizarProgresso(100, 'Busca concluída com sucesso!');
                    btnBuscar.disabled = false;
                    loading.style.display = 'none';
                } else if (data.type === 'error') {
                    eventSource.close();
                    handleFailure(new Error(data.message));
                    btnBuscar.disabled = false;
                    loading.style.display = 'none';
                }
            };

            eventSource.onerror = function(error) {
                eventSource.close();
                console.error('Erro na conexão SSE:', error);
                handleFailure(new Error('Erro na conexão com o servidor de backend. Verifique se o server.js está rodando.'));
                btnBuscar.disabled = false;
                loading.style.display = 'none';
            };
        }

        function handleFailure(error) {
            const guiasContainer = document.getElementById('guiasContainer');
            console.error('Erro geral na aplicação:', error);
            guiasContainer.innerHTML = `
                <div class="empty-state">
                    <div style="font-size: 3rem;">❌</div>
                    <h3>Erro na Execução</h3>
                    <p>${error.message || 'Ocorreu um erro desconhecido.'}</p>
                    <p style="margin-top: 10px;">Certifique-se de ter executado 'npm install' e iniciado o servidor com 'node server.js'.</p>
                </div>
            `;
        }
        
        function atualizarProgresso(percent, message) {
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            const progressDetails = document.getElementById('progressDetails');

            progressBar.style.width = percent + '%';
            progressText.textContent = Math.round(percent) + '%';
            progressDetails.textContent = message;
        }

        function exibirResultados(resultados) {
            const resumo = document.getElementById('resumo');
            const resumoGrid = document.getElementById('resumoGrid');
            const guiasContainer = document.getElementById('guiasContainer');

            const total = Object.values(resultados).reduce((sum, arr) => sum + arr.length, 0);
            
            if (total === 0) {
                 guiasContainer.innerHTML = `<div class="empty-state">... Nenhuma guia encontrada ...</div>`;
                 return;
            }

            const getPercentage = (count) => total > 0 ? (count / total * 100).toFixed(1) : 0;

            const porcentagens = {
                autorizadas: getPercentage(resultados.autorizadas.length),
                parcialmenteAutorizadas: getPercentage(resultados.parcialmenteAutorizadas.length),
                negadas: getPercentage(resultados.negadas.length),
                emAnalise: getPercentage(resultados.emAnalise.length),
                semGuiaOrigem: getPercentage(resultados.semGuiaOrigem.length)
            };

            resumoGrid.innerHTML = `
                <div class="resumo-item autorizadas">
                    <div class="resumo-numero">${resultados.autorizadas.length}</div>
                    <div>✅ Autorizadas / Executadas</div>
                    <div class="resumo-porcentagem">${porcentagens.autorizadas}%</div>
                </div>
                <div class="resumo-item parciais">
                    <div class="resumo-numero">${resultados.parcialmenteAutorizadas.length}</div>
                    <div>⚠️ Autorizadas Parcialmente</div>
                    <div class="resumo-porcentagem">${porcentagens.parcialmenteAutorizadas}%</div>
                </div>
                <div class="resumo-item negadas">
                    <div class="resumo-numero">${resultados.negadas.length}</div>
                    <div>❌ Negadas</div>
                    <div class="resumo-porcentagem">${porcentagens.negadas}%</div>
                </div>
                <div class="resumo-item analise">
                    <div class="resumo-numero">${resultados.emAnalise.length}</div>
                    <div>⏳ Em Análise</div>
                    <div class="resumo-porcentagem">${porcentagens.emAnalise}%</div>
                </div>
                <div class="resumo-item semGuiaOrigem">
                    <div class="resumo-numero">${resultados.semGuiaOrigem.length}</div>
                    <div>❓ Sem Guia Origem</div>
                    <div class="resumo-porcentagem">${porcentagens.semGuiaOrigem}%</div>
                </div>
            `;
            resumo.style.display = 'block';

            guiasContainer.innerHTML = '';

            const categorias = [
                { chave: 'parcialmenteAutorizadas', titulo: '⚠️ Guias de OPME c/ Origem Autorizada Parcialmente', icon: '⚠️' },
                { chave: 'negadas', titulo: '❌ Guias de OPME c/ Origem Negada', icon: '❌' },
                { chave: 'autorizadas', titulo: '✅ Guias de OPME c/ Origem Autorizada/Executada', icon: '✅' },
                { chave: 'emAnalise', titulo: '⏳ Guias de OPME c/ Origem Em Análise', icon: '⏳' },
                { chave: 'semGuiaOrigem', titulo: '❓ Guias de OPME Sem Guia de Origem / Erro', icon: '❓' }
            ];

            categorias.forEach(categoria => {
                if (resultados[categoria.chave].length > 0) {
                    const categoriaDiv = document.createElement('div');
                    categoriaDiv.className = `categoria categoria-${categoria.chave}`;
                    
                    const porcentagemCategoria = getPercentage(resultados[categoria.chave].length);

                    categoriaDiv.innerHTML = `
                        <div class="categoria-titulo">
                            <span>${categoria.icon} ${categoria.titulo}</span>
                            <span class="categoria-stats">
                                ${resultados[categoria.chave].length} guias (${porcentagemCategoria}%)
                            </span>
                        </div>
                    `;

                    resultados[categoria.chave].forEach(guia => {
                        // Não precisamos dessas linhas, pois 'guia' já contém os dados.
                        // const guia.statusOPME = guia.statusOPME; 
                        // const guia.statusOrigem = guia.statusOrigem; 

                        const guiaCard = criarCardGuia(guia, categoria.chave);
                        categoriaDiv.appendChild(guiaCard);
                    });

                    guiasContainer.appendChild(categoriaDiv);
                }
            });
        }

        function getStatusClass(status) {
            switch(status) {
                case 'Autorizada': 
                case 'Executada':
                    return 'status-autorizada';
                case 'Autorizada Parcialmente': 
                    return 'status-parcial';
                case 'Negada': 
                    return 'status-negada';
                case 'Em Análise':
                case 'Documentacao Em Analise':
                case 'Em Reanalise':
                    return 'status-analise';
                default: return 'status-nao-encontrada';
            }
        }
        
        function criarCardGuia(guia, categoria) {
            const card = document.createElement('div');
            card.className = 'guia-card';
            
            const statusClass = getStatusClass(guia.statusOrigem);
            const isSemOrigem = categoria === 'semGuiaOrigem';
            
            const headerHTML = `
                <div class="guia-header">
                    <div class="guia-info">
                        <h3>Guia de OPME - Nº ${guia.guiaOPME}</h3>
                        <div class="guia-detalhes">
                            ${isSemOrigem ? 
                                `**Tipo:** ${guia.tipoGuiaOrigem} (Status OPME: ${guia.statusOPME})` : 
                                `**Guia Origem:** ${guia.tipoGuiaOrigem} - Nº ${guia.guiaOrigem} (Status OPME: ${guia.statusOPME})`
                            }
                        </div>
                        ${!isSemOrigem ? `
                            <div class="guia-status ${statusClass} mt-2">
                                Status Guia de Origem: **${guia.statusOrigem}**
                            </div>
                        ` : ''}
                        <div class="guia-detalhes mt-1">**Beneficiário:** ${guia.beneficiario} - **Prestador:** ${guia.prestador}</div>
                    </div>
                    ${!isSemOrigem && guia.itensOrigem.length > 0 ? '<button class="expand-btn">▼</button>' : ''}
                </div>
            `;
            
            card.innerHTML = headerHTML;
            
            if (!isSemOrigem && guia.itensOrigem.length > 0) {
                const itensContainer = document.createElement('div');
                itensContainer.className = 'itens-container';
                itensContainer.innerHTML = '<div style="margin-bottom: 1rem; font-weight: bold; padding: 0.5rem 0;">Itens da Guia de Origem:</div>';
                
                guia.itensOrigem.forEach(item => {
                    const isNegado = item.quantAutorizada == 0;
                    const quantClass = isNegado ? 'quant-nao-autorizada' : 'quant-autorizada';
                    
                    itensContainer.innerHTML += `
                        <div class="item-lista">
                            <div class="item-codigo">Cód: ${item.codigo}</div>
                            <div class="item-descricao">${item.descricao}</div>
                            <div class="item-quantidades">
                                <span class="quant-solicitada">Solicitada: ${item.quantSolicitada}</span> - 
                                <span class="${quantClass}">Autorizada: ${item.quantAutorizada}</span>
                            </div>
                        </div>
                    `;
                });
                
                card.appendChild(itensContainer);

                const header = card.querySelector('.guia-header');
                const expandBtn = card.querySelector('.expand-btn');

                if (header && expandBtn && itensContainer) {
                    header.addEventListener('click', () => {
                        const isExpanded = itensContainer.classList.contains('show');
                        itensContainer.classList.toggle('show', !isExpanded);
                        expandBtn.classList.toggle('expanded', !isExpanded);
                    });
                }
            }

            return card;
        }
    </script>
</body>
</html>
